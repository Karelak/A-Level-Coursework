{% extends "base.html" %} {% block title %}Admin Dashboard - Meeting Room
Booking System{% endblock %} {% block content %}
<h2 class="mb-4">Admin Dashboard</h2>

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">All Bookings</h5>
    </div>
    <div class="card-body">
        {% if bookings %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="thead-light">
                    <tr>
                        <th>Booking ID</th>
                        <th>User</th>
                        <th>Room</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                    <tr>
                        <td>{{ booking.bookingid }}</td>
                        <td>
                            {{ booking.user.fname }} {{ booking.user.lname }}
                        </td>
                        <td>
                            {{ booking.room.roomname }} (Floor {{
                            booking.room.floor }})
                        </td>
                        <td>{{ booking.timebegin | iso_to_dmy_hm }}</td>
                        <td>{{ booking.timefinish | iso_to_dmy_hm }}</td>
                        <td>
                            <form
                                method="POST"
                                action="{{ url_for('bookings.cancel_booking', booking_id=booking.bookingid) }}"
                                class="d-inline"
                            >
                                <input
                                    type="hidden"
                                    name="csrf_token"
                                    value="{{ csrf_token() }}"
                                />
                                <button
                                    type="submit"
                                    class="btn btn-sm btn-danger"
                                    onclick="
                                        return confirm(
                                            'Are you sure you want to cancel this booking?',
                                        );
                                    "
                                >
                                    Cancel
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No bookings in the system.</p>
        {% endif %}
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">All Users</h5>
    </div>
    <div class="card-body">
        {% if users %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="thead-light">
                    <tr>
                        <th>User ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.userid }}</td>
                        <td>{{ user.fname }} {{ user.lname }}</td>
                        <td>{{ user.email }}</td>
                        <td>
                            <span
                                class="badge badge-{{ 'danger' if user.role == 'admin' else 'secondary' }}"
                                >{{ user.role }}</span
                            >
                        </td>
                        <td>
                            <form
                                method="POST"
                                action="{{ url_for('admin.delete_user', user_id=user.userid) }}"
                                class="d-inline"
                            >
                                <input
                                    type="hidden"
                                    name="csrf_token"
                                    value="{{ csrf_token() }}"
                                />
                                <button
                                    type="submit"
                                    class="btn btn-sm btn-danger"
                                    onclick="
                                        return confirm(
                                            'Are you sure you want to delete this user?',
                                        );
                                    "
                                >
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No users in the system.</p>
        {% endif %}

        <hr />
        <h6 class="mt-3 mb-3">Create New User</h6>
        <form
            method="POST"
            action="{{ url_for('admin.admin_create_user') }}"
            class="row g-3"
        >
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="col-md-6">
                <label for="fname" class="form-label">First Name</label>
                <input
                    type="text"
                    class="form-control"
                    id="fname"
                    name="fname"
                    required
                />
            </div>
            <div class="col-md-6">
                <label for="lname" class="form-label">Last Name</label>
                <input
                    type="text"
                    class="form-control"
                    id="lname"
                    name="lname"
                    required
                />
            </div>
            <div class="col-md-6">
                <label for="email" class="form-label">Email</label>
                <input
                    type="email"
                    class="form-control"
                    id="email"
                    name="email"
                    required
                />
            </div>
            <div class="col-md-6">
                <label for="password" class="form-label">Password</label>
                <input
                    type="password"
                    class="form-control"
                    id="password"
                    name="password"
                    required
                />
            </div>
            <div class="col-md-6">
                <label for="role" class="form-label">Role</label>
                <select id="role" name="role" class="form-control" required>
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    Create User
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">All Rooms</h5>
    </div>
    <div class="card-body">
        {% if rooms %}
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="thead-light">
                    <tr>
                        <th>Room ID</th>
                        <th>Room Name</th>
                        <th>Floor</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for room in rooms %}
                    <tr>
                        <td>{{ room.roomid }}</td>
                        <td>{{ room.roomname }}</td>
                        <td>{{ room.floor }}</td>
                        <td>
                            <form
                                method="POST"
                                action="{{ url_for('rooms.delete_room', room_id=room.roomid) }}"
                                class="d-inline"
                            >
                                <button
                                    type="submit"
                                    class="btn btn-sm btn-danger"
                                    onclick="
                                        return confirm(
                                            'Are you sure you want to delete this room?',
                                        );
                                    "
                                >
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted">No rooms in the system.</p>
        {% endif %}

        <hr />
        <h6 class="mt-3 mb-3">Create New Room</h6>
        <form
            method="POST"
            action="{{ url_for('rooms.admin_create_room') }}"
            class="row g-3"
        >
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="col-md-6">
                <label for="roomname" class="form-label">Room Name</label>
                <input
                    type="text"
                    class="form-control"
                    id="roomname"
                    name="roomname"
                    required
                />
            </div>
            <div class="col-md-6">
                <label for="floor" class="form-label">Floor</label>
                <input
                    type="number"
                    class="form-control"
                    id="floor"
                    name="floor"
                    required
                    min="1"
                    step="1"
                    pattern="[1-9][0-9]*"
                    oninput="if (this.value && this.value < 1) this.value = '';"
                />
            </div>
            <div class="col-12">
                <button type="submit" class="btn btn-primary">
                    Create Room
                </button>
            </div>
        </form>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Support Tickets</h5>
    </div>
    <div class="card-body">
        {% if tickets %} {% for ticket in tickets %}
        <div class="card mb-4">
            <div
                class="card-header {% if ticket.status == 'replied' %}bg-success{% else %}bg-warning{% endif %} text-white"
            >
                <div class="row align-items-center">
                    <div class="col">
                        <h6 class="mb-0">
                            Ticket #{{ ticket.ticketid }}: {{ ticket.subject }}
                        </h6>
                        <small
                            >From: {{ ticket.user.fname }} {{ ticket.user.lname
                            }} ({{ ticket.user.email }})</small
                        >
                    </div>
                    <div class="col-auto">
                        <span class="badge badge-light"
                            >{{ ticket.status }}</span
                        >
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <strong>Original Message:</strong>
                    <p class="text-muted mb-0">{{ ticket.message }}</p>
                    <small class="text-muted"
                        >{{ ticket.created_at | iso_to_dmy_hm }}</small
                    >
                </div>

                <div class="mt-4 pt-3 border-top">
                    <strong>Reply to Ticket:</strong>
                    <form
                        method="POST"
                        action="{{ url_for('support.reply_ticket', ticket_id=ticket.ticketid) }}"
                        class="mt-3"
                    >
                        <input
                            type="hidden"
                            name="csrf_token"
                            value="{{ csrf_token() }}"
                        />
                        <div class="form-group mb-3">
                            <textarea
                                name="reply"
                                class="form-control"
                                rows="4"
                                placeholder="Type your reply here..."
                                required
                            ></textarea>
                        </div>
                        <div class="btn-group">
                            <button
                                type="submit"
                                class="btn btn-sm btn-primary"
                            >
                                Send Reply & Notify User
                            </button>
                            <form
                                method="POST"
                                action="{{ url_for('support.delete_ticket', ticket_id=ticket.ticketid) }}"
                                class="d-inline"
                            >
                                <input
                                    type="hidden"
                                    name="csrf_token"
                                    value="{{ csrf_token() }}"
                                />
                                <button
                                    type="submit"
                                    class="btn btn-sm btn-danger"
                                    onclick="
                                        return confirm(
                                            'Are you sure you want to delete this ticket?',
                                        );
                                    "
                                >
                                    Delete Ticket
                                </button>
                            </form>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %} {% else %}
        <p class="text-muted">No support tickets in the system.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
